<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>任天堂 NPLN 服务架构演讲学习笔记 - Ramen's Box</title><meta name=Description content="Ramen's stuff box"><meta property="og:title" content="任天堂 NPLN 服务架构演讲学习笔记"><meta property="og:description" content="NPLN 是任天堂的新一代的通用多人在线游戏网络系统，旨在替代自 3DS 时代就使用的 NEX 系统，采用全面的现代架构来进行开发，目标是在玩家无感知的情况下替换掉 NEX。NPLN 自 2018 年开始开发，全面基于 Google Cloud，并于 2021 年首先在《怪物猎人：崛起》中进行使用。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.lxdlam.com/post/24e3aa77/"><meta property="og:image" content="https://blog.lxdlam.com/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-10T00:50:32+08:00"><meta property="article:modified_time" content="2023-01-04T02:01:57+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.lxdlam.com/logo.png"><meta name=twitter:title content="任天堂 NPLN 服务架构演讲学习笔记"><meta name=twitter:description content="NPLN 是任天堂的新一代的通用多人在线游戏网络系统，旨在替代自 3DS 时代就使用的 NEX 系统，采用全面的现代架构来进行开发，目标是在玩家无感知的情况下替换掉 NEX。NPLN 自 2018 年开始开发，全面基于 Google Cloud，并于 2021 年首先在《怪物猎人：崛起》中进行使用。"><meta name=application-name content="Ramen's Box"><meta name=apple-mobile-web-app-title content="Ramen's Box"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.lxdlam.com/post/24e3aa77/><link rel=prev href=https://blog.lxdlam.com/post/1f7260ad/><link rel=next href=https://blog.lxdlam.com/post/6918ebb9/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="UA-92306989-1"><meta name=baidu-site-verification content="092774cb717e6851abd2d7fc55835b40"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"任天堂 NPLN 服务架构演讲学习笔记","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.lxdlam.com\/post\/24e3aa77\/"},"image":["https:\/\/blog.lxdlam.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"NPLN, 任天堂, 学习笔记, 技术翻译","wordcount":4428,"url":"https:\/\/blog.lxdlam.com\/post\/24e3aa77\/","datePublished":"2022-10-10T00:50:32+08:00","dateModified":"2023-01-04T02:01:57+08:00","license":"本站所有内容基于署名-非商业性使用-相同方式共享 4.0 国际协议（CC BY-NC-SA 4.0）给出许可","publisher":{"@type":"Organization","name":"Ramen","logo":"https:\/\/blog.lxdlam.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Ramen"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Ramen's Box"><span class=header-title-pre><i class='fas fa-star'></i></span>Ramen's Box</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Ramen's Box"><span class=header-title-pre><i class='fas fa-star'></i></span>Ramen's Box</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">任天堂 NPLN 服务架构演讲学习笔记</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.lxdlam.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Ramen</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/><i class="far fa-folder fa-fw" aria-hidden=true></i>技术笔记</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-10>2022-10-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 4428 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 9 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#设计原则>设计原则</a><ul><li><a href=#为什么使用微服务>为什么使用微服务？</a></li><li><a href=#单体应用-vs-微服务>单体应用 vs 微服务</a><ul><li><a href=#单体应用>单体应用</a></li><li><a href=#微服务>微服务</a></li><li><a href=#npln-的选择>NPLN 的选择</a></li></ul></li><li><a href=#单租户或多租户>单租户或多租户</a><ul><li><a href=#单租户>单租户</a></li><li><a href=#多租户>多租户</a></li><li><a href=#npln-中的多租户>NPLN 中的多租户</a></li></ul></li></ul></li><li><a href=#架构>架构</a><ul><li><a href=#架构图与大纲图>架构图与大纲图</a></li><li><a href=#微服务的实现方案>微服务的实现方案</a></li><li><a href=#多租户配置的实现>多租户配置的实现</a></li><li><a href=#多集群配置的实现>多集群配置的实现</a></li></ul></li><li><a href=#使用-google-cloud-时遇到的问题与解决方案>使用 Google Cloud 时遇到的问题与解决方案</a><ul><li><a href=#对战匹配系统流程>对战匹配系统流程</a></li><li><a href=#agones-与-gamesync>Agones 与 Gamesync</a><ul><li><a href=#agones>Agones</a></li><li><a href=#gamesync>Gamesync</a></li></ul></li><li><a href=#allocate-吞吐量过低的问题与解决>Allocate 吞吐量过低的问题与解决</a></li><li><a href=#多集群化>多集群化</a></li><li><a href=#共享-gamesync>共享 Gamesync</a></li><li><a href=#game-servers-用例>Game Servers 用例</a><ul><li><a href=#多集群下-agones-的资源管理>多集群下 Agones 的资源管理</a></li><li><a href=#对-fleet-进行金丝雀canary发布>对 Fleet 进行金丝雀（Canary）发布</a></li><li><a href=#对集群进行蓝绿bluegreen发布>对集群进行蓝绿（Blue/Green）发布</a></li><li><a href=#gke-节点池更新时操作>GKE 节点池更新时操作</a></li></ul></li><li><a href=#spanner-的用例>Spanner 的用例</a><ul><li><a href=#已删除行的问题>已删除行的问题</a></li><li><a href=#ci-自动测试时的问题>CI 自动测试时的问题</a></li></ul></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class=content id=content><p>NPLN 是任天堂的新一代的通用多人在线游戏网络系统，旨在替代自 3DS 时代就使用的 NEX 系统，采用全面的现代架构来进行开发，目标是在玩家无感知的情况下替换掉 NEX。NPLN 自 2018 年开始开发，全面基于 Google Cloud，并于 2021 年首先在《怪物猎人：崛起》中进行使用。</p><p>截至目前，接入 NPLN 的游戏有下面三款：</p><ul><li>怪物猎人：崛起</li><li>宝可梦传说：阿尔宙斯</li><li>Splatoon 3</li></ul><p>这篇文章大体上是任天堂于 2022 年 4 月，在 Google 日本主办的 Google Cloud Day: Digital ’22 活动上做的主题演讲的笔记，内容大部分来自官方 slider 的翻译和截图。这次分享也是现在网上能找到最全面的 NPLN 服务端资料（SDK 暂未全面开放给所有开发者，任天堂自己采用面也不广），故特此总结以飨读者。由于我个人日语是个二把刀，内容如果有翻译不准确的地方，还请不吝赐教。</p><p>演讲材料：<a href="https://cloudonair.withgoogle.com/events/google-cloud-day-digital-22/watch?talk=d3-appdev-02" target=_blank rel="noopener noreffer">视频</a>，<a href=https://services.google.com/fh/files/events/gcd22-d3-appdev-02.pdf target=_blank rel="noopener noreffer">Slider</a></p><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>阅读提示<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>注意，这篇文章无法回答以下问题：</p><ol><li><p>为什么 Splatoon 3 联机还是这么烂？</p><p>NPLN 最大的更新是在游戏的其他在线体验上，而对局的联机方案还是跟 Splatoon 2 一样的基于 P2P 的方案。也就是说，2 代存在的问题，3 代大概仍然存在。</p><p>有种说法是 NPLN 有 UDP Relay，在 NAT 打洞失败后会 Fallback 到这种模式，由于官方演讲没有提及，我在此无法下定论。（根据数据挖掘的结果，NPLN <strong>也许</strong>使用了基于 WebRTC 的 TURN 模式）</p></li><li><p>具体 XXX 技术是怎么实现的？</p><p>目前由于 SDK 没有开放，同时逆向分析难度较大，本文仅总结任天堂在 GCD ‘22 上公开的部分，特别细节的部分暂时不知道。</p></li><li><p>这篇文章会涉及到具体某个游戏吗？</p><p>不会。本文只包含了 NPLN 服务端的整体架构和实现分析。对于游戏怎么接入的、SDK 怎么使用的等等都不包含在内。</p></li></ol></div></div></div><h2 id=设计原则>设计原则</h2><p>NPLN 的架构是微服务化的、面向多团队的合作开发架构。</p><h3 id=为什么使用微服务>为什么使用微服务？</h3><ul><li>以微服务为导向的设计：游戏开发规模扩大的对策<ul><li>需要支持的游戏服务和能力在增加</li><li>任天堂内部使用这套系统的开发者也在增加</li></ul></li><li>支持多租户的设计：需要使用这套系统的作品数量增加的对策<ul><li>运转、维护的负担降低</li><li>资源使用率良好</li></ul></li></ul><p>为了达成这些目标，在系统设计时选择了一些在最初系统（NEX）设计和实现时不存在或者并不被广泛采纳的技术。</p><h3 id=单体应用-vs-微服务>单体应用 vs 微服务</h3><h4 id=单体应用>单体应用</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341584_f89806c7.png title=https://assets.lxdlam.com/img/1665341584_f89806c7.png data-thumbnail=https://assets.lxdlam.com/img/1665341584_f89806c7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341584_f89806c7.png data-srcset="https://assets.lxdlam.com/img/1665341584_f89806c7.png, https://assets.lxdlam.com/img/1665341584_f89806c7.png 1.5x, https://assets.lxdlam.com/img/1665341584_f89806c7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341584_f89806c7.png width=100%></a><ul><li><span style=color:blue>服务之间的联动较为容易</span></li><li><span style=color:red>发布周期（リリースサイクル，Release Cycle）会影响所有服务</span></li><li><span style=color:red>很难看到各个服务各自的负载</span></li></ul><h4 id=微服务>微服务</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341564_e02b3876.png title=https://assets.lxdlam.com/img/1665341564_e02b3876.png data-thumbnail=https://assets.lxdlam.com/img/1665341564_e02b3876.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341564_e02b3876.png data-srcset="https://assets.lxdlam.com/img/1665341564_e02b3876.png, https://assets.lxdlam.com/img/1665341564_e02b3876.png 1.5x, https://assets.lxdlam.com/img/1665341564_e02b3876.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341564_e02b3876.png width=100%></a><ul><li><span style=color:red>服务之间的联动较为麻烦</span></li><li><span style=color:blue>各个服务的发布周期独自分离</span></li><li><span style=color:blue>各个服务的负载可独立观测</span></li></ul><h4 id=npln-的选择>NPLN 的选择</h4><ul><li>基于强调各个服务开发和运营的独立性的考量，NPLN 使用微服务架构。</li><li>在实现上，任天堂采用了 Kubernetes 和 Istio 作为基础设施，并使用 Google Cloud 的 Google Kubernetes Engine（下称 GKE）和 Anthos 服务网格来构建系统。</li></ul><h3 id=单租户或多租户>单租户或多租户</h3><blockquote><p>租户（マルチテナント，Tenant）：在本文中，一个游戏作品（タイトル，Title）相关的服务和基础设施统称为一个租户。</p></blockquote><h4 id=单租户>单租户</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341570_489c5535.png title=https://assets.lxdlam.com/img/1665341570_489c5535.png data-thumbnail=https://assets.lxdlam.com/img/1665341570_489c5535.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341570_489c5535.png data-srcset="https://assets.lxdlam.com/img/1665341570_489c5535.png, https://assets.lxdlam.com/img/1665341570_489c5535.png 1.5x, https://assets.lxdlam.com/img/1665341570_489c5535.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341570_489c5535.png width=100%></a><p>单租户即每个作品的服务实例、DB 均在单独的集群中隔离管理、维护。</p><p>优点：</p><ul><li>易于定制</li><li>可扩展性的上限估计时仅需要考虑单个租户</li><li>易于隔离服务负载以及其他因素的影响</li></ul><p>缺点：</p><ul><li>随着租户数量的增加，管理难度将会上升</li><li>剩余的资源利用效率较低</li></ul><blockquote><p>译注：在演讲中，可扩展性的主要关注对象是 DB，所以下文中仅针对 DB 的可扩展性提供了解决方案。</p></blockquote><h4 id=多租户>多租户</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341565_00aa09a4.png title=https://assets.lxdlam.com/img/1665341565_00aa09a4.png data-thumbnail=https://assets.lxdlam.com/img/1665341565_00aa09a4.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341565_00aa09a4.png data-srcset="https://assets.lxdlam.com/img/1665341565_00aa09a4.png, https://assets.lxdlam.com/img/1665341565_00aa09a4.png 1.5x, https://assets.lxdlam.com/img/1665341565_00aa09a4.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341565_00aa09a4.png width=100%></a><p>多租户即所有 DB、游戏实例均在同一个集群中管理、维护。</p><p>优点：</p><ul><li>即使租户数量增加，管理也会较为容易</li><li>剩余的资源使用效率较高</li></ul><p>缺点：</p><ul><li>定制难度高</li><li>可扩展性上限估计需要考虑多个租户</li><li>服务负载及其他因素影响可能会扩散到全体租户</li></ul><h4 id=npln-中的多租户>NPLN 中的多租户</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341580_08f754e4.png title=https://assets.lxdlam.com/img/1665341580_08f754e4.png data-thumbnail=https://assets.lxdlam.com/img/1665341580_08f754e4.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341580_08f754e4.png data-srcset="https://assets.lxdlam.com/img/1665341580_08f754e4.png, https://assets.lxdlam.com/img/1665341580_08f754e4.png 1.5x, https://assets.lxdlam.com/img/1665341580_08f754e4.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341580_08f754e4.png width=100%></a><p>原则：基于多租户的设计，但是也允许部分单租户的混合配置系统。</p><p>对缺点的应对方案：</p><ul><li><p>定制难度高</p><p>对于某些租户的特定逻辑，如对战匹配（マッチメイク，Matchmaking）等，使用 DSL 进行描述和抽象，使得开发者可以便捷定制开发。</p></li><li><p>可扩展性上限估计需要考虑多个租户</p><p>使用 Cloud Spanner 来作为主 DB 方案，这样在多个租户共享 DB 实例时也可以确保可扩展性。</p></li><li><p>服务负载及其他因素影响可能会扩散到全体租户</p><p>在必要的情况下通过对路由进行调整，可以针对某些租户的特定服务进行实例隔离，（译注：进而避免实例/集群等之间的影响）。</p></li></ul><blockquote><p>译注：这种情况其实称为混合租户（Hybrid-tenancy）更合理。</p></blockquote><h2 id=架构>架构</h2><h3 id=架构图与大纲图>架构图与大纲图</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341577_9d53ab65.png title=https://assets.lxdlam.com/img/1665341577_9d53ab65.png data-thumbnail=https://assets.lxdlam.com/img/1665341577_9d53ab65.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341577_9d53ab65.png data-srcset="https://assets.lxdlam.com/img/1665341577_9d53ab65.png, https://assets.lxdlam.com/img/1665341577_9d53ab65.png 1.5x, https://assets.lxdlam.com/img/1665341577_9d53ab65.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341577_9d53ab65.png width=100%></a><ul><li>客户端，即 Nintendo Switch 侧，使用 C++ 开发 NPLN SDK</li><li>服务端，即 NPLN 服务器侧，使用 Go 语言进行开发，并将所有基础设施建设在 Google Cloud 中</li><li>客户端和服务端使用 gRPC 协议进行交互</li></ul><a class=lightgallery href=https://assets.lxdlam.com/img/1665341571_2b32a4f8.png title=https://assets.lxdlam.com/img/1665341571_2b32a4f8.png data-thumbnail=https://assets.lxdlam.com/img/1665341571_2b32a4f8.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341571_2b32a4f8.png data-srcset="https://assets.lxdlam.com/img/1665341571_2b32a4f8.png, https://assets.lxdlam.com/img/1665341571_2b32a4f8.png 1.5x, https://assets.lxdlam.com/img/1665341571_2b32a4f8.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341571_2b32a4f8.png width=100%></a><ul><li>Nintendo Switch 主机之间使用 P2P 模式进行通信</li><li>客户端通过 Cloud Load Balancing 访问运行在 GKE 上的 NPLN 服务器</li><li>使用基于 Istio 的 Anthos 服务网格进行流量调度管理</li><li>使用基于 Agones 的 Game Servers 进行游戏服务器管理</li><li>日志等指标被发送到 BigQuery 进行分析</li></ul><blockquote><p>译注：</p><ol><li>实际的通信方式是一种混合 P2P 模式，下文会进一步解释。</li><li>这里的 Game Servers 指的是 Google Cloud 的 Game Server 产品，并非我们传统意义上理解的独立游戏服务器（Dedicated Game Server），在下文中也会进一步解释。</li></ol></blockquote><h3 id=微服务的实现方案>微服务的实现方案</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665344199_4074c169.png title=https://assets.lxdlam.com/img/1665344199_4074c169.png data-thumbnail=https://assets.lxdlam.com/img/1665344199_4074c169.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665344199_4074c169.png data-srcset="https://assets.lxdlam.com/img/1665344199_4074c169.png, https://assets.lxdlam.com/img/1665344199_4074c169.png 1.5x, https://assets.lxdlam.com/img/1665344199_4074c169.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665344199_4074c169.png width=100%></a><ul><li>由于支持混合类型的多租户以及多种游戏服务，NPLN 的每个服务都运行在单独的 Pod 里面</li><li>gRPC 的方法则将其构造成类似于 http 路径的方案，在 Istio 中基于路径进行路由</li><li>使用 VirtualService 将服务器和客户端之间的连接合二为一，而各个服务之间使用 namespace 来进行隔离。</li></ul><h3 id=多租户配置的实现>多租户配置的实现</h3><p>VirtualService 同样用于实现多租户配置。下面的三张图展示了不同主机运行不同游戏情况下的流量调度去向。</p><p><a class=lightgallery href=https://assets.lxdlam.com/img/1665341586_ed526cbc.png title=https://assets.lxdlam.com/img/1665341586_ed526cbc.png data-thumbnail=https://assets.lxdlam.com/img/1665341586_ed526cbc.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341586_ed526cbc.png data-srcset="https://assets.lxdlam.com/img/1665341586_ed526cbc.png, https://assets.lxdlam.com/img/1665341586_ed526cbc.png 1.5x, https://assets.lxdlam.com/img/1665341586_ed526cbc.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341586_ed526cbc.png width=100%></a>
<a class=lightgallery href=https://assets.lxdlam.com/img/1665341581_d38f25d7.png title=https://assets.lxdlam.com/img/1665341581_d38f25d7.png data-thumbnail=https://assets.lxdlam.com/img/1665341581_d38f25d7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341581_d38f25d7.png data-srcset="https://assets.lxdlam.com/img/1665341581_d38f25d7.png, https://assets.lxdlam.com/img/1665341581_d38f25d7.png 1.5x, https://assets.lxdlam.com/img/1665341581_d38f25d7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341581_d38f25d7.png width=100%></a>
<a class=lightgallery href=https://assets.lxdlam.com/img/1665341574_d6864e99.png title=https://assets.lxdlam.com/img/1665341574_d6864e99.png data-thumbnail=https://assets.lxdlam.com/img/1665341574_d6864e99.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341574_d6864e99.png data-srcset="https://assets.lxdlam.com/img/1665341574_d6864e99.png, https://assets.lxdlam.com/img/1665341574_d6864e99.png 1.5x, https://assets.lxdlam.com/img/1665341574_d6864e99.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341574_d6864e99.png width=100%></a></p><h3 id=多集群配置的实现>多集群配置的实现</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341572_b8f1c35d.png title=https://assets.lxdlam.com/img/1665341572_b8f1c35d.png data-thumbnail=https://assets.lxdlam.com/img/1665341572_b8f1c35d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341572_b8f1c35d.png data-srcset="https://assets.lxdlam.com/img/1665341572_b8f1c35d.png, https://assets.lxdlam.com/img/1665341572_b8f1c35d.png 1.5x, https://assets.lxdlam.com/img/1665341572_b8f1c35d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341572_b8f1c35d.png width=100%></a><ul><li>在逻辑层面上，NPLN 有多个逻辑集群，如生产环境集群、测试环境集群以及管理平面集群等，目前使用多个 GKE 集群来进行分离</li><li>每个集群的配置都集中在管理平面集群上，通过管理后台（ダッシュボード，Dashboard）进行调整，并推送到各个集群的服务中</li><li>集群间的通信使用基于 mTLS 的 Istio 代理隧道进行</li><li>使用 Istio 的 VirtualService、DestinationRule、ServiceEntry、Gateway 等 CRD 组件来实现各个集群中服务间的透明访问</li><li>由于设计实现时 Anthos 的多集群功能在 beta 阶段，未来会考虑稳定后迁移到 Anthos 的多集群管理功能</li></ul><h2 id=使用-google-cloud-时遇到的问题与解决方案>使用 Google Cloud 时遇到的问题与解决方案</h2><h3 id=对战匹配系统流程>对战匹配系统流程</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341578_db029fdb.png title=https://assets.lxdlam.com/img/1665341578_db029fdb.png data-thumbnail=https://assets.lxdlam.com/img/1665341578_db029fdb.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341578_db029fdb.png data-srcset="https://assets.lxdlam.com/img/1665341578_db029fdb.png, https://assets.lxdlam.com/img/1665341578_db029fdb.png 1.5x, https://assets.lxdlam.com/img/1665341578_db029fdb.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341578_db029fdb.png width=100%></a><ol><li>Nintendo Switch 客户端提出对战匹配请求</li><li>NPLN 服务器从 Cloud Spanner 中查找或者创建游戏 Session</li><li>Agones 创建 Gamesync 实例</li><li>Gamesync 将状态报告给 NPLN 服务器</li><li>NPLN 服务器将 Gamesync 的信息返回给客户端</li><li>客户端各自连接 Gamesync</li><li>客户端之间开始 P2P 通信</li></ol><p>Gamesync 是用于保存 Session 相关游戏状态的服务，一个 Session 对应一个 Gamesync 实例。举例来说，假定某一时刻有 100 万玩家在线，而这个游戏的在线模式每个 Session 有四位玩家，则我们可以估计这个时刻约有 25 万个不同的 Gamesync 实例。</p><h3 id=agones-与-gamesync>Agones 与 Gamesync</h3><h4 id=agones>Agones</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341579_c0ed5354.png title=https://assets.lxdlam.com/img/1665341579_c0ed5354.png data-thumbnail=https://assets.lxdlam.com/img/1665341579_c0ed5354.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341579_c0ed5354.png data-srcset="https://assets.lxdlam.com/img/1665341579_c0ed5354.png, https://assets.lxdlam.com/img/1665341579_c0ed5354.png 1.5x, https://assets.lxdlam.com/img/1665341579_c0ed5354.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341579_c0ed5354.png width=100%></a><ul><li>用于管理游戏服务器的开源软件（OSS，Open Source Software）</li><li>游戏服务器群被称作 Fleet 进行管理，而每个游戏服务器使用 Pod 进行运行管理，在 NPLN 中即 Gamesync</li><li>Controller 负责管理整个系统，Allocator 负责创建 GameServer 实例</li><li>游戏服务器状态管理<ul><li>Allocated：正在使用中</li><li>Ready：可以使用</li></ul></li><li>FleetAutoscaler 可以对 Buffer 进行管理<ul><li>监控并自动扩容，以满足服务稳定要求的最少 Ready 状态 Pod 数等</li></ul></li></ul><h4 id=gamesync>Gamesync</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341567_aa46629d.png title=https://assets.lxdlam.com/img/1665341567_aa46629d.png data-thumbnail=https://assets.lxdlam.com/img/1665341567_aa46629d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341567_aa46629d.png data-srcset="https://assets.lxdlam.com/img/1665341567_aa46629d.png, https://assets.lxdlam.com/img/1665341567_aa46629d.png 1.5x, https://assets.lxdlam.com/img/1665341567_aa46629d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341567_aa46629d.png width=100%></a><ul><li>Gamesync 是游戏 Session 管理服务器，用来对每个 Session 进行相关的状态管理</li><li>功能<ul><li>强一致内存数据库，支持多个客户端对复杂数据结构的随机读写</li><li>游戏状态变更时进行实时通知</li></ul></li><li>使用方式举例<ul><li>管理在 P2P 中容易出现不一致的状态</li><li>P2P 连接中的 Signaling 流程的处理</li></ul></li></ul><blockquote><p>译注：根据数据挖掘的结果，任天堂在 NPLN SDK 中包含了 WebRTC 库，猜测在 NPLN 中使用了 WebRTC 来实现 P2P，而 Signaling 是 WebRTC 中一个专用服务器，起到了常规 NAT 穿越过程中 STUN/TURN 服务发现的功能。</p><p>所以，第二个使用方式中，可能的意思是 Gamesync 也会负责客户端之间 P2P NAT 穿越的工作。</p></blockquote><h3 id=allocate-吞吐量过低的问题与解决>Allocate 吞吐量过低的问题与解决</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341568_aef5d68f.png title=https://assets.lxdlam.com/img/1665341568_aef5d68f.png data-thumbnail=https://assets.lxdlam.com/img/1665341568_aef5d68f.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341568_aef5d68f.png data-srcset="https://assets.lxdlam.com/img/1665341568_aef5d68f.png, https://assets.lxdlam.com/img/1665341568_aef5d68f.png 1.5x, https://assets.lxdlam.com/img/1665341568_aef5d68f.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341568_aef5d68f.png width=100%></a><ul><li>Allocate 的职责<ul><li>Gamesync 发生状态变更时进行处理</li><li>将 Pod 的状态从 Ready 迁移到 Allocated</li></ul></li><li>Allocate 操作的吞吐量低于预期<ul><li>创建了单独的 Forked Agones 来 Debug</li></ul></li><li>猜测是 GKE 控制平面带来的延迟<ul><li>Cloud Trace 中没观察到显著延迟</li><li>专注于不可观测的控制平面部分</li></ul></li></ul><a class=lightgallery href=https://assets.lxdlam.com/img/1665341563_dc686dd5.png title=https://assets.lxdlam.com/img/1665341563_dc686dd5.png data-thumbnail=https://assets.lxdlam.com/img/1665341563_dc686dd5.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341563_dc686dd5.png data-srcset="https://assets.lxdlam.com/img/1665341563_dc686dd5.png, https://assets.lxdlam.com/img/1665341563_dc686dd5.png 1.5x, https://assets.lxdlam.com/img/1665341563_dc686dd5.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341563_dc686dd5.png width=100%></a><ul><li>通过重复创建和删除轻量级 Pod 来进行实验，并最终确认性能没有到达预期，换句话说这就是问题所在</li><li>通过将预留 node 数量增加到 500 获得性能提升<ul><li>Pod 的操作 QPS 从 20 增加到 100</li><li>Allocate 的吞吐量也确认得到提升</li></ul></li><li>通过 Pod 重用进一步获得性能提升<ul><li>默认在每个 Pod 使用完毕后直接删除</li><li>将删除操作修改为从 Allocated 状态迁移到 Ready</li></ul></li></ul><blockquote><p>译注：在 GKE <a href=https://cloud.google.com/kubernetes-engine/docs/best-practices/scalability#dimension_limits target=_blank rel="noopener noreffer">文档</a>中，明确提到了第一个解决方案相关的限制：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png title=https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png data-thumbnail=https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png data-srcset="https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png, https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png 1.5x, https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341561_0fcfa6f4.png width=100%></a></blockquote><h3 id=多集群化>多集群化</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341591_a0b1d942.png title=https://assets.lxdlam.com/img/1665341591_a0b1d942.png data-thumbnail=https://assets.lxdlam.com/img/1665341591_a0b1d942.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341591_a0b1d942.png data-srcset="https://assets.lxdlam.com/img/1665341591_a0b1d942.png, https://assets.lxdlam.com/img/1665341591_a0b1d942.png 1.5x, https://assets.lxdlam.com/img/1665341591_a0b1d942.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341591_a0b1d942.png width=100%></a><ul><li>单集群的性能上限<ul><li>Gamesync 分配速度受 GKE 控制平面性能限制</li></ul></li><li>多集群提升可扩展性<ul><li>由 NPLN 服务来分发请求到具体集群上</li></ul></li><li>可基于集群数量来进行扩展<ul><li>作为权衡，运营成本可能会增加</li></ul></li></ul><h3 id=共享-gamesync>共享 Gamesync</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341595_c740d230.png title=https://assets.lxdlam.com/img/1665341595_c740d230.png data-thumbnail=https://assets.lxdlam.com/img/1665341595_c740d230.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341595_c740d230.png data-srcset="https://assets.lxdlam.com/img/1665341595_c740d230.png, https://assets.lxdlam.com/img/1665341595_c740d230.png 1.5x, https://assets.lxdlam.com/img/1665341595_c740d230.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341595_c740d230.png width=100%></a><ul><li>Google Cloud 的限制<ul><li>每个区域的最大集群数量</li><li>大量的集群操作导致运营成本增加</li><li>资源消费效率低</li></ul></li><li>解决方案：在一个 Gamesync 中共享多个 Session<ul><li>从逻辑上分离 Gamesync</li></ul></li><li>效果<ul><li>集群操作量显著减少</li><li>改善资源使用效率</li></ul></li></ul><h3 id=game-servers-用例>Game Servers 用例</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341588_01f5e6ad.png title=https://assets.lxdlam.com/img/1665341588_01f5e6ad.png data-thumbnail=https://assets.lxdlam.com/img/1665341588_01f5e6ad.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341588_01f5e6ad.png data-srcset="https://assets.lxdlam.com/img/1665341588_01f5e6ad.png, https://assets.lxdlam.com/img/1665341588_01f5e6ad.png 1.5x, https://assets.lxdlam.com/img/1665341588_01f5e6ad.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341588_01f5e6ad.png width=100%></a><ul><li>用于管理多个 Agones 集群的 Google Cloud 托管服务</li><li>NPLN 的用例<ul><li>对多集群化的 Agones 进行资源管理</li><li>对 Fleet 进行金丝雀发布</li><li>对集群进行蓝绿发布</li></ul></li><li>一种用例<ul><li>在可以在 Game Servers 中创建不同的配置，并在发布时针对不同的大区（Realm）使用不同的配置。</li></ul></li></ul><h4 id=多集群下-agones-的资源管理>多集群下 Agones 的资源管理</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341587_3757a235.png title=https://assets.lxdlam.com/img/1665341587_3757a235.png data-thumbnail=https://assets.lxdlam.com/img/1665341587_3757a235.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341587_3757a235.png data-srcset="https://assets.lxdlam.com/img/1665341587_3757a235.png, https://assets.lxdlam.com/img/1665341587_3757a235.png 1.5x, https://assets.lxdlam.com/img/1665341587_3757a235.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341587_3757a235.png width=100%></a><ul><li>不使用 Game Servers 的情况下<ul><li>Operator 必须手动操作不同集群的 Agones 实例</li></ul></li><li>使用 Game Servers 的情况下<ul><li>Game Servers 可以同步操作不同集群下的 Agones 实例，仅操作特定集群也是可以的</li></ul></li></ul><h4 id=对-fleet-进行金丝雀canary发布>对 Fleet 进行金丝雀（Canary）发布</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341583_b45e0db7.png title=https://assets.lxdlam.com/img/1665341583_b45e0db7.png data-thumbnail=https://assets.lxdlam.com/img/1665341583_b45e0db7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341583_b45e0db7.png data-srcset="https://assets.lxdlam.com/img/1665341583_b45e0db7.png, https://assets.lxdlam.com/img/1665341583_b45e0db7.png 1.5x, https://assets.lxdlam.com/img/1665341583_b45e0db7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341583_b45e0db7.png width=100%></a><ul><li>通过划分 Deployment 进行金丝雀发布<ul><li>在确认正常工作后进行全量 Deployment</li></ul></li><li>这样即使新版本不符合预期也不会影响整体服务<ul><li>出现问题时，非线上版本的 Pod 只有极小部分</li><li>如果出现问题，则逐个回滚</li></ul></li></ul><h4 id=对集群进行蓝绿bluegreen发布>对集群进行蓝绿（Blue/Green）发布</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341585_ade02d9a.png title=https://assets.lxdlam.com/img/1665341585_ade02d9a.png data-thumbnail=https://assets.lxdlam.com/img/1665341585_ade02d9a.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341585_ade02d9a.png data-srcset="https://assets.lxdlam.com/img/1665341585_ade02d9a.png, https://assets.lxdlam.com/img/1665341585_ade02d9a.png 1.5x, https://assets.lxdlam.com/img/1665341585_ade02d9a.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341585_ade02d9a.png width=100%></a><ul><li>在 GKE 和 Agones 更新时使用<ul><li>出现问题则立即回滚</li></ul></li><li>Game Servers<ul><li>增加新集群，删除旧集群</li></ul></li><li>NPLN 服务<ul><li>增加新集群的端点</li><li>删除旧集群的端点</li></ul></li><li>旧集群清理<ul><li>当 Allocated 状态的 Gamesync 到达 0 后则删除旧集群</li></ul></li></ul><h4 id=gke-节点池更新时操作>GKE 节点池更新时操作</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341592_cbd8a0af.png title=https://assets.lxdlam.com/img/1665341592_cbd8a0af.png data-thumbnail=https://assets.lxdlam.com/img/1665341592_cbd8a0af.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341592_cbd8a0af.png data-srcset="https://assets.lxdlam.com/img/1665341592_cbd8a0af.png, https://assets.lxdlam.com/img/1665341592_cbd8a0af.png 1.5x, https://assets.lxdlam.com/img/1665341592_cbd8a0af.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341592_cbd8a0af.png width=100%></a><ul><li>保证节点上已经没有用户了再进行更新<ul><li>在此节点上不能创建新的 Session</li><li>处于 Allocated 状态的 Pod 不能删除</li></ul></li><li>对 Gamesync 使用 Kubernetes 的 Cordon 标记功能<ul><li>Cordon 状态的 node 上不会被创建新的 Pod</li><li>处于 Allocated 状态的 Pod 不会被删除</li><li>可以保证在用户无感知的情况下进行更新</li></ul></li></ul><h3 id=spanner-的用例>Spanner 的用例</h3><a class=lightgallery href=https://assets.lxdlam.com/img/1665341593_3b2ec14a.png title=https://assets.lxdlam.com/img/1665341593_3b2ec14a.png data-thumbnail=https://assets.lxdlam.com/img/1665341593_3b2ec14a.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341593_3b2ec14a.png data-srcset="https://assets.lxdlam.com/img/1665341593_3b2ec14a.png, https://assets.lxdlam.com/img/1665341593_3b2ec14a.png 1.5x, https://assets.lxdlam.com/img/1665341593_3b2ec14a.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341593_3b2ec14a.png width=100%></a><ul><li>原则上将 Spanner 用于需要直接面向用户的服务</li><li>在对战匹配中<ul><li>管理 Session 的状态</li><li>读写操作发生频率较高</li></ul></li><li>按实例与服务为单元进行隔离</li></ul><h4 id=已删除行的问题>已删除行的问题</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341597_83373ee1.png title=https://assets.lxdlam.com/img/1665341597_83373ee1.png data-thumbnail=https://assets.lxdlam.com/img/1665341597_83373ee1.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341597_83373ee1.png data-srcset="https://assets.lxdlam.com/img/1665341597_83373ee1.png, https://assets.lxdlam.com/img/1665341597_83373ee1.png 1.5x, https://assets.lxdlam.com/img/1665341597_83373ee1.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341597_83373ee1.png width=100%></a><ul><li>Spanner 中已删除的行会物理上保留一段时间<ul><li>在几天到一周的时间内会被实际删除掉</li><li>这种等待被删除的行被称作 Tombstone</li></ul></li><li>在长期测试中，搜索性能会逐渐下降<ul><li>当某一行被删除后，由于这一行实际还会存在一段时间，在此之后才不会被扫描到</li></ul></li><li>基于 Tombstone 存在状态下的考虑<ul><li>基于性能损失的前提下，实验出需要的节点数量</li><li>考察高峰期将持续多长时间</li></ul></li></ul><blockquote><p>译注：根据<a href=https://cloud.google.com/spanner/docs/ttl target=_blank rel="noopener noreffer">官方文档</a>的说法，这个可能是因为 Spanner TTL 的配置出现了问题。</p></blockquote><h4 id=ci-自动测试时的问题>CI 自动测试时的问题</h4><a class=lightgallery href=https://assets.lxdlam.com/img/1665341596_e6f17ede.png title=https://assets.lxdlam.com/img/1665341596_e6f17ede.png data-thumbnail=https://assets.lxdlam.com/img/1665341596_e6f17ede.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1665341596_e6f17ede.png data-srcset="https://assets.lxdlam.com/img/1665341596_e6f17ede.png, https://assets.lxdlam.com/img/1665341596_e6f17ede.png 1.5x, https://assets.lxdlam.com/img/1665341596_e6f17ede.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1665341596_e6f17ede.png width=100%></a><ul><li>Spanner 模拟器的功能缺失<ul><li>功能缺失带来的问题<ul><li>无法并行执行多个事务 → 无法确定是否存在多事务竞争</li><li>无法使用特定的 HINT 语句 → 无法确定是否带来性能优化</li><li>无法获取统计数据 → 无法确定是否特定修改劣化了性能</li></ul></li><li>根据测试分支的重要性，跳过一部分测试</li></ul></li><li>使用真实 Spanner 实例进行自动化测试的问题<ul><li>在自动化测试环境中使用 Cloud Build 并尽可能并行化</li><li>高频创建和删除数据库时会带来的延迟</li><li>增加测试并行度时最大 DB 数的限制</li></ul></li></ul><h2 id=summary>Summary</h2><ul><li>NPLN 是基于微服务云原生的现代架构，作为任天堂的通用在线游戏基础设施为未来新游戏提供服务，强调了多团队合作下的扩展性和维护性，提升研发效能，降低运营成本。</li><li>在架构设计上，整套系统使用了基于 Service Mesh 的微服务方案，并通过 Kubernetes+Agones 来管控整个系统的资源，客户端则使用 gRPC 进行通信。</li><li>整套架构构建在 Google Cloud 上，并在基础设施上使用了特定产品：GKE、Spanner，BigQuery 等。</li><li>整套架构支持现代开发和观测流程，包括 CI/CD 自动化测试，Canary、Blue/Green 发布，基于大型数据仓库的近实时/离线数据分析等。</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-01-04</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.lxdlam.com/post/24e3aa77/ data-title="任天堂 NPLN 服务架构演讲学习笔记" data-hashtags=NPLN,任天堂,学习笔记,技术翻译><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.lxdlam.com/post/24e3aa77/ data-hashtag=NPLN><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Instapaper" data-sharer=instapaper data-url=https://blog.lxdlam.com/post/24e3aa77/ data-title="任天堂 NPLN 服务架构演讲学习笔记" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/instapaper.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Pocket" data-sharer=pocket data-url=https://blog.lxdlam.com/post/24e3aa77/><i class="fab fa-get-pocket fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.lxdlam.com/post/24e3aa77/ data-title="任天堂 NPLN 服务架构演讲学习笔记"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://blog.lxdlam.com/post/24e3aa77/ data-title="任天堂 NPLN 服务架构演讲学习笔记"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/npln/>NPLN</a>,&nbsp;<a href=/tags/%E4%BB%BB%E5%A4%A9%E5%A0%82/>任天堂</a>,&nbsp;<a href=/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a>,&nbsp;<a href=/tags/%E6%8A%80%E6%9C%AF%E7%BF%BB%E8%AF%91/>技术翻译</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/post/1f7260ad/ class=prev rel=prev title="picoCTF 2022 Crypto Write-ups"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>picoCTF 2022 Crypto Write-ups</a>
<a href=/post/6918ebb9/ class=next rel=next title="Hackergame 2022 题解">Hackergame 2022 题解<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.lxdlam.com target=_blank>Ramen</a></span>&nbsp;|&nbsp;<span class=license><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>署名-非商业性使用-相同方式共享 4.0 国际</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-92306989-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-92306989-1" async></script></body></html>